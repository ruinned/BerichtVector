/**********************************************************************************************************************
 *  COPYRIGHT
 *  -------------------------------------------------------------------------------------------------------------------
 *  \verbatim
 *  Copyright (c) 2015 by Vector Informatik GmbH.                                                  All rights reserved.
 *
 *                This software is copyright protected and proprietary to Vector Informatik GmbH.
 *                Vector Informatik GmbH grants to you only those rights as set out in the license conditions.
 *                All other rights remain with Vector Informatik GmbH.
 *  \endverbatim
 *  -------------------------------------------------------------------------------------------------------------------
 *  FILE DESCRIPTION
 *  -----------------------------------------------------------------------------------------------------------------*/
/**        \file  spi.c
 *        \brief  spi source file
 *
 *        \details basic input/output
 *
 *********************************************************************************************************************/

/**********************************************************************************************************************
 *  REVISION HISTORY
 *  -------------------------------------------------------------------------------------------------------------------
 *  Refer to the module's header file.
 * 
 *  FILE VERSION
 *  -------------------------------------------------------------------------------------------------------------------
 *  Refer to the VERSION CHECK below.
 *********************************************************************************************************************/

#define SPI_SOURCE

/**********************************************************************************************************************
 *  INCLUDES
 *********************************************************************************************************************/

#include "spi.h"
#include <avr/io.h>

/**********************************************************************************************************************
 *  VERSION CHECK
 *********************************************************************************************************************/

/* Check the version of spi header file */
#if (  (SPI_SW_MAJOR_VERSION != (1u)) \
    || (SPI_SW_MINOR_VERSION != (0u)) \
    || (SPI_SW_PATCH_VERSION != (0u)) )
# error "Vendor specific version numbers of spi.c and spi.h are inconsistent"
#endif


/**********************************************************************************************************************
 *  LOCAL CONSTANT MACROS
 **********************************************************************************************************************/
/*! \brief Example symbolic constant */
#define MSN_MY_SYMBOLIC_CONSTANT        (0x05u)
/*! \brief Reset value for ... */
#define MSN_MY_RESETVALUE               (0x00u)

/**********************************************************************************************************************
 *  LOCAL FUNCTION MACROS
 **********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL DATA TYPES AND STRUCTURES
 **********************************************************************************************************************/

/* Preprocessor define STATIC is no longer available in Compiler.h in MSR4 - provide local define */
#if !defined (STATIC)
# define STATIC static
#endif

/**********************************************************************************************************************
 *  LOCAL DATA PROTOTYPES
 **********************************************************************************************************************/

/**********************************************************************************************************************
 *  GLOBAL DATA
 **********************************************************************************************************************/

/**********************************************************************************************************************
 *  LOCAL FUNCTION PROTOTYPES
 **********************************************************************************************************************/

#define SPI_START_SEC_CODE
#include "MemMap.h" /* PRQA S 5087 */ /* MD_MSR_19.1 */


/**********************************************************************************************************************
 *  LOCAL FUNCTIONS
 **********************************************************************************************************************/




/**********************************************************************************************************************
 *  GLOBAL FUNCTIONS
 **********************************************************************************************************************/

/***********************************************************************************************************************
 *  spi_InitMemory()
 **********************************************************************************************************************/
/*! \brief      Function for *_INIT_*-variable initialization
 *  \details    Service to initialize module global variables at power up. This function can be used to initialize the
 *              variables in *_INIT_* sections in case they are not initialized by the startup code.
 *  \pre        Module must not be initialized
 *  \pre        Function shall be called from task level
 **********************************************************************************************************************/
void spi_InitMemory(void)
{
  /* ----- Implementation ----------------------------------------------- */

}  /* spi_InitMemory() */


/**********************************************************************************************************************
 * spi_Init()
 **********************************************************************************************************************/
/*! \brief      Initialization function
 *  \details    This function initializes the module spi. It initializes all variables and and sets the module state to
 *              initialized.
 *  \param[in]  -
 *  \pre        Interrupts have to be disabled.
 *  \pre        The module has to be uninitialized.
 *  \pre        spi_InitMemory has been called unless spi_ModuleInitialized is initialized by start-up code.
 *  \note       Specification of module initialization
 **********************************************************************************************************************/
void spi_Init(void)
{
  /* The !SS pin must be set to output! */
  /* 1MBit rate */
  SPCR = _BV(MSTR) | _BV(SPR0);
  SPCR |= _BV(SPE);
}


/**********************************************************************************************************************
 * spi_transfer()
 **********************************************************************************************************************/
/*! \brief      This function transfers a single byte
 *  \details    This function is used to transfer a byte via spi, wait until finished and return the received byte
 *              
 *  \param[in]  -
 *  \pre        
 *  \pre        The module has to be initialized.
 *  \pre        spi_InitMemory has been called unless spi_ModuleInitialized is initialized by start-up code.
 *  \note       
 **********************************************************************************************************************/
uint8 spi_transfer(uint8 data)
{
  uint8 result;

  SPDR = data;
  /* Wait for previous transfer to complete */
  while(0 != (SPSR & _BV(SPIF)));
  result = SPDR;

  return(result);
}


#define SPI_STOP_SEC_CODE
#include "MemMap.h" /* PRQA S 5087 */ /* MD_MSR_19.1 */

/**********************************************************************************************************************
 *  END OF FILE: spi.c
 *********************************************************************************************************************/
